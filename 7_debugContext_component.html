<html>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script> -->

<!-- vue live component - require http server -->
<script src="https://unpkg.com/http-vue-loader"></script>

<!-- vue js component - works offline -->
<!-- <script src="7_component.js"></script> -->

<body>

  <div id="app">
    <my-component></my-component>
    <p>{{ message }}</p>
    <button v-on:click="reverseMessage">Reverse Message</button>
  </div>

  <script src="./simple-jsonprc-js.js"></script>
  <script>
    var jrpc = new simple_jsonrpc()

    function createSocket() {
      var socket = new WebSocket("ws://localhost:1000")
      socket.onmessage = async event => {
        let text = await event.data.text()
        // split multiple json messages in one string
        let lines = text.split("\n")
        let i = 0;
        let str = ""
        for (; i < lines.length; ++i) {
          str += lines[i]
          if (lines[i] == "}") {
            try {
              JSON.parse(str)
              jrpc.messageHandler(str)
              str = ""
            } catch (e) { }
          }
        }
        if (str.length > 0)
          jrpc.messageHandler(str)
      }
      jrpc.toStream = _msg => socket.send(_msg)

      socket.onopen = data => console.log("socked connected: ", data)
      socket.onerror = error => console.error("socket error: " + error.message)

      socket.addEventListener('open', (event) => {
        start()
      })

      socket.onclose = function (event) {
        if (event.wasClean) {
          console.info('Connection close was clean')
        } else {
          console.error('Connection suddenly close')
        }
        console.info('socket close code : ' + event.code + ' reason: ' + event.reason)
        console.log(`reconnect... `)
        setTimeout(createSocket, 1000)
      }
    }
    createSocket()

    var firstStart = true
    function start() {
      if (!firstStart)
        return
      firstStart = false
      var app5 = new Vue({
        el: '#app',
        data: {
          message: 'Hello Vue.js!'
        },
        methods: {
          reverseMessage: function () {
            jrpc.call('reverse', [this.message]).then((data) => this.message = data)
          }
        },
        mounted() {
          jrpc.on("giveHelp", data => {
            console.log("giveHelp message ", data)
            return "help"
          })
          console.log("app mounted")
          jrpc.notification("whatsup")
        },
        // vue live component - require http server
        components: {
          'my-component': httpVueLoader('7_component.vue')
        }
      })
    }
  </script>

</body>

</html>